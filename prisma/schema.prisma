generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  password             String
  fullName             String
  phone                String?
  role                 Role      @default(CUSTOMER)
  isVerified           Boolean   @default(false)
  verificationToken    String?
  resetPasswordToken   String?
  resetPasswordExpires DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  addresses Address[]
  orders    Order[]
  reviews   Review[]
  wishlist  Wishlist[]
  cart      Cart?
}

enum Role {
  CUSTOMER
  ADMIN
}

model Product {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  brand         String
  category      Category
  description   String   @db.Text
  price         Decimal  @db.Decimal(10, 2)
  discountPrice Decimal? @db.Decimal(10, 2)
  stock         Int
  sku           String   @unique
  isActive      Boolean  @default(true)
  rating        Decimal  @default(0) @db.Decimal(3, 2)
  totalReviews  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  images         ProductImage[]
  variants       ProductVariant[]
  specifications ProductSpecification?
  reviews        Review[]
  wishlist       Wishlist[]
  cartItems      CartItem[]
  orderItems     OrderItem[]
}

enum Category {
  FULL_FACE
  HALF_FACE
  OPEN_FACE
  MODULAR
  OFF_ROAD
  KIDS
  LADIES
}

model ProductImage {
  id           String  @id @default(uuid())
  productId    String
  imageUrl     String
  isPrimary    Boolean @default(false)
  displayOrder Int

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductVariant {
  id              String  @id @default(uuid())
  productId       String
  size            Size
  color           String
  stock           Int
  sku             String  @unique
  additionalPrice Decimal @default(0) @db.Decimal(10, 2)

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  orderItems OrderItem[]
}

enum Size {
  XS
  S
  M
  L
  XL
  XXL
  FREE_SIZE
}

model ProductSpecification {
  id             String   @id @default(uuid())
  productId      String   @unique
  weight         String
  material       String
  certifications String[]
  visorType      String
  ventilation    Boolean
  features       String[]

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Address {
  id           String      @id @default(uuid())
  userId       String
  fullName     String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  pinCode      String
  country      String      @default("India")
  addressType  AddressType
  isDefault    Boolean     @default(false)
  createdAt    DateTime    @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]
}

enum AddressType {
  HOME
  OFFICE
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  productId String
  variantId String?
  quantity  Int
  addedAt   DateTime @default(now())

  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([cartId, productId, variantId])
}

model Order {
  id                String        @id @default(uuid())
  orderNumber       String        @unique
  userId            String
  addressId         String
  subtotal          Decimal       @db.Decimal(10, 2)
  discount          Decimal       @default(0) @db.Decimal(10, 2)
  shippingCharge    Decimal       @db.Decimal(10, 2)
  tax               Decimal       @default(0) @db.Decimal(10, 2)
  total             Decimal       @db.Decimal(10, 2)
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus @default(PENDING)
  orderStatus       OrderStatus   @default(PENDING)
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?
  trackingNumber    String?
  notes             String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user    User        @relation(fields: [userId], references: [id])
  address Address     @relation(fields: [addressId], references: [id])
  items   OrderItem[]
  reviews Review[]
}

enum PaymentMethod {
  RAZORPAY
  COD
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

model OrderItem {
  id           String  @id @default(uuid())
  orderId      String
  productId    String
  variantId    String?
  productName  String
  productImage String
  size         String
  color        String
  price        Decimal @db.Decimal(10, 2)
  quantity     Int
  subtotal     Decimal @db.Decimal(10, 2)

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])
}

model Review {
  id                 String   @id @default(uuid())
  productId          String
  userId             String
  orderId            String
  rating             Int
  title              String
  comment            String   @db.Text
  images             String[]
  isVerifiedPurchase Boolean  @default(true)
  isApproved         Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@unique([userId, productId, orderId])
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String
  productId String
  addedAt   DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model Coupon {
  id            String       @id @default(uuid())
  code          String       @unique
  description   String
  discountType  DiscountType
  discountValue Decimal      @db.Decimal(10, 2)
  minPurchase   Decimal      @db.Decimal(10, 2)
  maxDiscount   Decimal?     @db.Decimal(10, 2)
  usageLimit    Int
  usedCount     Int          @default(0)
  validFrom     DateTime
  validUntil    DateTime
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Newsletter {
  id           String   @id @default(uuid())
  email        String   @unique
  isSubscribed Boolean  @default(true)
  subscribedAt DateTime @default(now())
}

model Visitor {
  id         String   @id @default(uuid())
  ip         String
  userAgent  String?  @db.Text
  page       String
  referrer   String?
  country    String?
  city       String?
  device     String?  // mobile, tablet, desktop
  browser    String?
  os         String?
  sessionId  String   // groups page views into sessions
  userId     String?  // if logged in
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([sessionId])
  @@index([ip])
}

model BlogPost {
  id          String        @id @default(uuid())
  title       String
  slug        String        @unique
  excerpt     String        @db.Text
  content     String        @db.Text
  coverImage  String?
  author      String        @default("Admin")
  tags        String[]      @default([])
  category    String        @default("General")
  isPublished Boolean       @default(false)
  publishedAt DateTime?
  metaTitle   String?
  metaDesc    String?       @db.Text
  views       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@index([publishedAt])
}
